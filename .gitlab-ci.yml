
cache:
  paths:
    - node_modules/
    - .next/
    - .env

stages:
  - env
  - build
  - docker

build:
  image: node:12.18.0
  stage: build
  script:
    - cat .env
    - yarn install --pure-lockfile
    - yarn build
  only:
    - development
    - master

docker:
  image: docker:latest
  stage: docker
  services:
    - docker:dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --build-arg VCS_REF=`git rev-parse --short HEAD` --build-arg BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"` --pull -t "$IMAGE_TAG" .
    - docker push "$IMAGE_TAG"
  only:
    - development
    - master
